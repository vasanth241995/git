
    - name: Creating folder to store the files from Jfrog
      win_file:
        path: C:\TEMP\Java_Upgrade\{{ Change_Number }}
        state: directory
        mode: u=rwx,g=rwx,o=rwx
        
    - name: downlaod java 8 exe from Jfrog
      win_get_url:
        url: "{{ Java8_url }}"
        dest: C:\TEMP\Java_Upgrade\{{ Change_Number }}\
        url_username: Svc-dsd-cicd
        url_password: "AKCp8ohoBfpQ1AxHiKb1hqaLhdZAabKp6uoTbzB8rH1f61S8owCBaAAB8ZDREGJ2oY26LgWyu"
      when: optJDK8 == "YES"
      
    - name: downlaod java 11 exe from Jfrog
      win_get_url:
        url: "{{ Java11_url }}"
        dest: C:\TEMP\Java_Upgrade\{{ Change_Number }}\
        url_username: Svc-dsd-cicd
        url_password: "AKCp8ohoBfpQ1AxHiKb1hqaLhdZAabKp6uoTbzB8rH1f61S8owCBaAAB8ZDREGJ2oY26LgWyu"
      when: optJDK11 == "YES"
      
    #- name: downlaod root cert from Jfrog
      #win_get_url:
        #url: "{{ Root_cert_url }}"
        #dest: C:\TEMP\Java_Upgrade\{{ Change_Number }}\
        #url_username: SvcAcct_OUTSOL_SCM
        #url_password: "AP712kwKRV4CetBgZphrCjL1uYb6yZ9y4cTsaT"

    #- name: downlaod intermediate cert from Jfrog
      #win_get_url:
        #url: "{{ Inter_cert_url }}"
        #dest: C:\TEMP\Java_Upgrade\{{ Change_Number }}\
        #url_username: SvcAcct_OUTSOL_SCM
        #url_password: "AP712kwKRV4CetBgZphrCjL1uYb6yZ9y4cTsaT"
        
    - name: Fetch Java version
      win_shell: java -version
      register: version_info
      
    - debug:
        msg: "{{ version_info.stderr_lines[0] }}"
    
    - name: Install Java 8
      win_shell: |
        $workd = "C:\TEMP\Java_Upgrade\{{ Change_Number }}"
        $text = '
        INSTALL_SILENT=Enable
        AUTO_UPDATE=Enable
        SPONSORS=Disable
        REMOVEOUTOFDATEJRES=1
        '
        $text | Set-Content "$workd\jreinstall.cfg"
        Start-Process -FilePath "$workd\{{ Executable_name_java8 }}" -ArgumentList INSTALLCFG="$workd\jreinstall.cfg"
        Start-Sleep -s 180
      when: optJDK8 == "YES"

    - name: Set Java_home
      win_environment:
        state: present
        name: JAVA_HOME
        value: 'c:\program files\java\jdk{{ new_java8_version}}'
        level: machine
      when: 
        - Processor_Type == "64-bit"
        - optJDK8 == "YES"
        - HOME_TYPE == "JAVA_HOME"
        
    - name: Set Java_home
      win_environment:
        state: present
        name: JAVA_HOME
        value: 'c:\program files\java\jre\{{ new_java8_version}}'
        level: machine
      when: 
        - Processor_Type == "64-bit"
        - optJDK8 == "YES"
        - HOME_TYPE == "JRE_HOME"

    - name: Add Java to path
      win_path:
        elements:
          - 'c:\program files\java\jdk{{ new_java8_version}}\bin'
      when: 
        - Processor_Type == "64-bit"
        - optJDK8 == "YES"
        
    - name: Set Java_home
      win_environment:
        state: present
        name: JAVA_HOME
        value: 'C:\Program Files (x86)\Java\jdk{{ new_java8_version}}'
        level: machine
      when: 
        - Processor_Type == "32-bit"
        - optJDK8 == "YES"
        
    - name: Set Java_home
      win_environment:
        state: present
        name: JRE_HOME
        value: 'C:\Program Files (x86)\Java\jre{{ new_java8_version}}'
        level: machine
      when: 
        - Processor_Type == "32-bit"
        - optJDK8 == "YES"
        - HOME_TYPE == "JRE_HOME"

    - name: Add Java to path
      win_path:
        elements:
          - 'C:\Program Files (x86)\Java\jdk{{ new_java8_version}}\bin'
      when: 
        - Processor_Type == "32-bit"
        - optJDK8 == "YES"
      
    #- name: Import cert
      #win_command: >
        #keytool -importcert
        #-noprompt
        #-alias "{{item.alias}}"
        #-file C:\TEMP\Java_Upgrade\{{ Change_Number }}\{{item.path}}
        #-keystore "{{ truststore_path8 }}"
        #-storepass "{{ truststore_password8 }}"
        #-trustcacerts
      #with_items:
        #- { path: "{{ Root_cert }}", alias: new_root_cert }
        #- { path: "{{ Inter_cert }}", alias: new_inter_cert }
      #args:
        #chdir: "{{ java_path8 }}"
      #when: optJDK8 == "YES"
      
    - name: Install Java 11
      win_shell: |
        $workd = "C:\TEMP\Java_Upgrade\{{ Change_Number }}"
        $text = '
        INSTALL_SILENT=Enable
        AUTO_UPDATE=Enable
        SPONSORS=Disable
        REMOVEOUTOFDATEJRES=1
        '
        $text | Set-Content "$workd\jreinstall.cfg"
        Start-Process -FilePath "$workd\{{ Executable_name_java11 }}" -ArgumentList INSTALLCFG="$workd\jreinstall.cfg"
        Start-Sleep -s 180
      when: optJDK11 == "YES"
      
    - name: Set Java_home
      win_environment:
        state: present
        name: JAVA_HOME
        value: 'c:\program files\java\jdk{{ new_java11_version}}'
        level: machine
      when: 
        - Processor_Type == "64-bit"
        - optJDK11 == "YES"

    - name: Add Java to path
      win_path:
        elements:
          - 'c:\program files\java\jdk{{ new_java11_version}}\bin'
      when: 
        - Processor_Type == "64-bit"
        - optJDK11 == "YES"
        
    - name: Set Java_home
      win_environment:
        state: present
        name: JAVA_HOME
        value: 'C:\Program Files (x86)\Java\jdk{{ new_java11_version}}'
        level: machine
      when: 
        - Processor_Type == "32-bit"
        - optJDK11 == "YES"

    - name: Add Java to path
      win_path:
        elements:
          - 'C:\Program Files (x86)\Java\jdk{{ new_java11_version}}\bin'
      when: 
        - Processor_Type == "32-bit"
        - optJDK11 == "YES"
        
    #- name: Import cert
      #win_command: >
        #keytool -importcert
        #-noprompt
        #-alias "{{item.alias}}"
        #-file C:\TEMP\Java_Upgrade\{{ Change_Number }}\{{item.path}}
        #-keystore "{{ truststore_path11 }}"
        #-storepass "{{ truststore_password11 }}"
        #-trustcacerts
      #args:
        #chdir: "{{ java_path11 }}"
      #with_items:
        #- { path: "{{ Root_cert }}", alias: new_root_cert }
        #- { path: "{{ Inter_cert }}", alias: new_inter_cert }
      #when: optJDK11 == "YES"
      
    #- debug:
        #msg: "{{ hostvars['vwmazdsmdr01.fisdev.local']['service_list'] }}"
      
    #- set_fact: service_list="{{ (hostvars['vwmazdsmdr01.fisdev.local']['service_list']).split(',') }}"
    #- debug:
        #msg: "{{ item }}"
      #with_items: "{{ service_list }}"
    
    #- name: Starting with service restart loop
      #include_tasks: ServiceRestart.yml
      #loop: "{{ service_list }}"
       
    - name: Fetch Java version
      win_shell: java -version
      register: version_info
      
    - debug:
        msg: "{{ version_info.stderr_lines[0] }}"
        
    #- name: Uninstall java 8
      #win_command: wmic product where "name like 'java se%'" call uninstall
      #when: optJDK8 == "YES"
      
    #- name: Uninstall java 8
      #win_command: wmic product where "Name like 'Java 8 Update {{ my_int_var }} %%'" call uninstall /nointeractive
      #when: optJDK8 == "YES"

    #- name: Uninstall java 11
      #win_command: wmic product where "Name like 'Java%% {{ old_java11_version }} %%'" call uninstall /nointeractive
      #when: optJDK11 == "YES"
      
    - name: Removing existing folder
      win_file:
        path: C:\TEMP\Java_Upgrade\{{ Change_Number }}
        state: absent
